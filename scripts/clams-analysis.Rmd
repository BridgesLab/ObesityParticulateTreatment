---
title: "Analysis of Pre-HFD CLAMS Data for High Fat Diet Particulate Treatment Study"
author: Dave Bridges, Alyse Ragauskas, Erin Stephenson, JeAnna Redd, Jyothi Parvathareddy, Sridhar Jaligama, Stephania
  Cormier and Joan Han
date: "November 13, 2014"
output:
  html_document:
    keep_md: true
---
This was the data from the CLAMS study performed on the 9 week old mice.  This script was most recently run on `r date()`.

```{r global_options, include=FALSE}
library(knitr)
opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE,dev=c('png','pdf'))
options(scipen=8,digits =4)
```

```{r data-entry}
sample_key_file <- '../data/CLAMS/mouse_treatments.csv'
sample_key <- read.csv(sample_key_file)

mri_data_file <- '../data/CLAMS/2014-09-15 Maternal Particulate.xlsx'
library(xlsx)
mri_data <- read.xlsx2(mri_data_file, sheetIndex=1)
mri_data$Fat <- as.numeric(as.character(mri_data$Fat))
mri_data$Lean <- as.numeric(as.character(mri_data$Lean))
mri_data$Weight <- as.numeric(as.character(mri_data$Weight))

clams_data_file_first <- '../data/CLAMS/2014-09-15/2014-09-15 Maternal Particulate OXYMAX.csv'
clams_data_file_second <- '../data/CLAMS/2014-09-19/2014-09-19 Maternal Particulate OXYMAX.csv'

#load in the data
first_data <- read.csv(clams_data_file_first)
second_data <- read.csv(clams_data_file_second)
second_data$Event.Log <- rep(NA, dim(second_data)[1])

all.data <- rbind(first_data,second_data)
all.data$Subject <- as.factor(all.data$Subject)
remove.intervals <- 40
all.data.clean <- subset(all.data, Subject != '1119'&Interval>remove.intervals&Subject!='1096')
```

The input files were `r mri_data_file` for the echoMRI data and `r clams_data_file_first` and `r clams_data_file_second` for the CLAMS data.  

```{r analysis}
library(reshape2)
se <- function(x) sd(x)/sqrt(length(x))

summarized.data <- dcast(Subject~Light.Dark, data=all.data.clean, mean, value.var='Volume.O2')
summarized.data.heat <- dcast(Subject~Light.Dark, data=all.data.clean, mean, value.var='Heat')
summarized.data.err <- dcast(Subject~Light.Dark, data=all.data.clean, se, value.var='Volume.O2')

RER.data <- dcast(Subject~Light.Dark, data=all.data.clean, mean, value.var='RER')
RER.data.annotated <- merge(RER.data, sample_key, by.x='Subject', by.y='Mouse.ID')
Activity.data <- dcast(Subject~Light.Dark, data=all.data.clean, mean, value.var='X.Ambulatory')
Activity.data.annotated <- merge(Activity.data, sample_key, by.x='Subject', by.y='Mouse.ID')
Heat.data <- dcast(Subject~Light.Dark, data=all.data.clean, mean, value.var='Heat')

combined.data <- merge(summarized.data, mri_data[,c('Label','Lean','Fat','Weight')], by.x='Subject', by.y="Label")
combined.data.heat <- merge(summarized.data.heat, mri_data[,c('Label','Lean','Fat','Weight')], by.x='Subject', by.y="Label")

combined.data$Dark.raw <- combined.data$Dark * combined.data$Weight/1000
combined.data$Light.raw <- combined.data$Light * combined.data$Weight/1000

combined.data.heat$Dark.raw <- combined.data.heat$Dark
combined.data.heat$Light.raw <- combined.data.heat$Light

combined.data.err <- merge(summarized.data.err, mri_data[,c('Label','Lean','Fat','Weight')], by.x='Subject', by.y="Label")

combined.data.err$Dark.raw <- combined.data.err$Dark * combined.data.err$Weight/1000
combined.data.err$Light.raw <- combined.data.err$Light * combined.data.err$Weight/1000
annotated.data.o2 <- merge(combined.data, sample_key, by.x='Subject', by.y='Mouse.ID')
annotated.data.heat <- merge(combined.data.heat, sample_key, by.x='Subject', by.y='Mouse.ID')

#for linear mixed effects

#annotated all data with weights and groups
full.clean.data <- merge(all.data.clean, mri_data[,c('Label','Lean','Fat','Weight')], by.x='Subject', by.y="Label")
full.annotated.data <- merge(full.clean.data, sample_key, by.x='Subject', by.y='Mouse.ID')

library(lme4)
complete.lme <- lmer(Volume.O2 ~ Light.Dark + Weight + Particulate.Treatment + (1|Subject), data=full.annotated.data, REML=T)
no.treatment.lme <- lmer(Volume.O2 ~ Light.Dark + Weight + (1|Subject), data=full.annotated.data, REML=T)

library(multcomp)
lme.ph <- glht(complete.lme, infct=mcp(Particulate.Treatment='Dunnett'))
complete.lme.lean <- lmer(Volume.O2 ~ Light.Dark + Lean + Particulate.Treatment + (1|Subject), data=full.annotated.data, REML=T)
no.treatment.lme.lean <- lmer(Volume.O2 ~ Light.Dark + Lean + (1|Subject), data=full.annotated.data, REML=T)
lme.ph.lean <- glht(complete.lme.lean, infct=mcp(Particulate.Treatment='Dunnett'))
```

## Resting Metabolic Rate

The VO2 levels were first merged to average over light and dark cycles, removing the first `r remove.intervals` measurements.  To analyse these data we performed an ANCOVA analysis using body weight as the primary covariate. 

```{r VO2-by-weight,dev=c('png','pdf')}
superpose.eb <- function (x, y, ebl, ebu = ebl, length = 0.08, ...)
  arrows(x, y + ebu, x, y - ebl, angle = 90, code = 3,
  length = length, ...)

par(mfrow=c(1,2))
with(annotated.data.o2, plot(Weight, Dark.raw, ylim=c(0,max(Dark.raw)),
                         pch=19, las=2, ylab="VO2 (mL/h)", main='Dark', col=Particulate.Treatment))
legend("bottomright", levels(annotated.data.o2$Particulate.Treatment), pch=19, col=palette()[1:3], lty=1, bty='n')

dark.lm <- lm(Dark.raw~Weight+Particulate.Treatment, data=annotated.data.o2)
dark.aov <- aov(Dark.raw~Weight+Particulate.Treatment, data=annotated.data.o2)

abline(a=coefficients(dark.lm)[1],
       b=coefficients(dark.lm)[2], col=palette()[1])
abline(a=coefficients(dark.lm)[1]+coefficients(dark.lm)['Particulate.TreatmentMCP'],
       b=coefficients(dark.lm)[2], col=palette()[2])
abline(a=coefficients(dark.lm)[1]+coefficients(dark.lm)['Particulate.TreatmentSaline'],
       b=coefficients(dark.lm)[2], col=palette()[3])

with(annotated.data.o2, plot(Weight, Light.raw, ylim=c(0,max(Dark.raw)),
                         pch=19, las=2, ylab="VO2 (mL/h)", main='Light',col=Particulate.Treatment))
legend("bottomright", levels(annotated.data.o2$Particulate.Treatment), pch=19, col=palette()[1:3], lty=1, bty='n')
light.lm <- lm(Light.raw~Weight+Particulate.Treatment, data=annotated.data.o2)
light.aov <- aov(Light.raw~Weight+Particulate.Treatment, data=annotated.data.o2)

abline(a=coefficients(light.lm)[1],
       b=coefficients(light.lm)[2], col=palette()[1])
abline(a=coefficients(light.lm)[1]+coefficients(light.lm)['Particulate.TreatmentMCP'],
       b=coefficients(light.lm)[2], col=palette()[2])
abline(a=coefficients(light.lm)[1]+coefficients(light.lm)['Particulate.TreatmentSaline'],
       b=coefficients(light.lm)[2], col=palette()[3])

#superpose.eb(annotated.data.o2$Weight, annotated.data.o2$Light.raw, combined.data.err$Light.raw)
```

We first checked whether normality was maintained in the residuals from the ANCOVA.  The normality assumption was met for both Dark (p=`r shapiro.test(residuals(dark.aov))$p.value`) and Light (p=`r shapiro.test(residuals(light.aov))$p.value`) via Shapiro-Wilk test.  

According to this analysis there was no significant effect of the treatment group on the body weight-adjusted VO2 levels under either Dark (p=`r summary(dark.aov)[[1]]$"Pr(>F)"[2]`) or Light (p=`r summary(light.aov)[[1]]$"Pr(>F)"[2]`) conditions.  There was also no significant effect of body weight in either Dark (p=`r summary(dark.aov)[[1]]$"Pr(>F)"[1]`) or Light (p=`r summary(light.aov)[[1]]$"Pr(>F)"[1]`) conditions.  We detected a `r coefficients(light.lm)['Particulate.TreatmentMCP']/coefficients(light.lm)['(Intercept)']*100`% reduction in metabolic rate between MCP and Cabosil groups in the light and a `r coefficients(dark.lm)['Particulate.TreatmentMCP']/coefficients(dark.lm)['(Intercept)']*100`% reduction in the dark.

Alternatively we used a mixed linear model, with non-interacting covariates for the Light cycle, the Weight and the Particulate treatment.  A F-test comparing a model with or without the Particulate treatment yielded a p-value of `r anova(complete.lme, no.treatment.lme)$"Pr(>Chisq)"[2]`.  Post-hoc tests for the effects of particulate treatment are shown in the Table below.  According to this MCP treatment reduces VO2 by `r summary(lme.ph, test=adjusted(type='none'))$test$coefficients[4]/summary(lme.ph, test=adjusted(type='none'))$test$coefficients[1]*100`%, p=`r summary(lme.ph, test=adjusted(type='none'))$test$pvalue[4]`.

```{r vo2-post-hoc, results='asis'}
library(xtable)
tukey.table <- data.frame(
  Coefficient = summary(lme.ph, test=adjusted(type='BH'))$test$coefficients,
  p.value = summary(lme.ph,test=adjusted(type='none'))$test$pvalue[1:5])

print(xtable(tukey.table, caption="Post-hoc Dunnett's tests of mixed linear model correcting for effects of light cycle and total body mass on V02.  P-values are not corrected.", label='tab:vo2-lme-ph', digits=c(0,0,3)), type='html')

tukey.table.lean <- data.frame(
  Coefficient = summary(lme.ph.lean, test=adjusted(type='BH'))$test$coefficients,
  p.value = summary(lme.ph.lean,test=adjusted(type='none'))$test$pvalue[1:5])

print(xtable(tukey.table.lean, caption="Post-hoc Dunnett's sests of mixed linear model correcting for effects of light cycle and lean body mass on V02.  P-values are not corrected.", label='tab:vo2-lme-lean-ph', digits=c(0,0,3)), type='html')
```
## Normalization by Lean Body Mass

```{r VO2-by-LBM, dev=c('png','pdf')}
par(mfrow=c(1,2))
with(annotated.data.o2, plot(Lean, Dark.raw, ylim=c(0,max(Dark.raw)),
                         pch=19, las=2, ylab="VO2 (mL/h)", main='Dark',col=Particulate.Treatment))
legend("bottomright", levels(annotated.data.o2$Particulate.Treatment), pch=19, col=palette()[1:3], lty=1, bty='n')

#anova
dark.lm.lean <- lm(Dark.raw~Lean+Particulate.Treatment, data=annotated.data.o2)
dark.aov.lean <- aov(Dark.raw~Lean+Particulate.Treatment, data=annotated.data.o2)

abline(a=coefficients(dark.lm.lean)[1],
       b=coefficients(dark.lm.lean)[2], col=palette()[1])
abline(a=coefficients(dark.lm.lean)[1]+coefficients(dark.lm.lean)['Particulate.TreatmentMCP'],
       b=coefficients(dark.lm.lean)[2], col=palette()[2])
abline(a=coefficients(dark.lm.lean)[1]+coefficients(dark.lm.lean)['Particulate.TreatmentSaline'],
       b=coefficients(dark.lm.lean)[2], col=palette()[3])
#superpose.eb(combined.data$Lean, combined.data$Dark.raw, combined.data.err$Dark.raw)

with(annotated.data.o2, plot(Lean, Light.raw, ylim=c(0,max(Dark.raw)),
                         pch=19, las=2, ylab="VO2 (mL/h)", main='Light',col=Particulate.Treatment))
legend("bottomright", levels(annotated.data.o2$Particulate.Treatment), pch=19, col=palette()[1:3], lty=1, bty='n')
light.lm.lean <- lm(Light.raw~Lean+Particulate.Treatment, data=annotated.data.o2)
light.aov.lean <- aov(Light.raw~Lean+Particulate.Treatment, data=annotated.data.o2)

abline(a=coefficients(light.lm.lean)[1],
       b=coefficients(light.lm.lean)[2], col=palette()[1])
abline(a=coefficients(light.lm.lean)[1]+coefficients(light.lm.lean)['Particulate.TreatmentMCP'],
       b=coefficients(light.lm.lean)[2], col=palette()[2])
abline(a=coefficients(light.lm.lean)[1]+coefficients(light.lm.lean)['Particulate.TreatmentSaline'],
       b=coefficients(light.lm.lean)[2], col=palette()[3])
#superpose.eb(combined.data$Lean, combined.data$Light.raw, combined.data.err$Dark.raw)
```

Using the lean mass as the covariate, we checked whether normality was maintained in the residuals from the ANCOVA.  The normality assumption was met for both Dark (p=`r shapiro.test(residuals(dark.aov.lean))$p.value`) and Light (p=`r shapiro.test(residuals(light.aov.lean))$p.value`) via Shapiro-Wilk test.  

According to this analysis there was no significant effect of the treatment group on the body weight-adjusted VO2 levels under either Dark (p=`r summary(dark.aov.lean)[[1]]$"Pr(>F)"[2]`) or Light (p=`r summary(light.aov.lean)[[1]]$"Pr(>F)"[2]`) conditions.  There was also no effect of body weight in either Dark (p=`r summary(dark.aov.lean)[[1]]$"Pr(>F)"[1]`) or Light (p=`r summary(light.aov.lean)[[1]]$"Pr(>F)"[1]`) conditions.  Analysed this way, we detected a `r coefficients(light.lm.lean)['Particulate.TreatmentMCP']/coefficients(light.lm.lean)['(Intercept)']*100`% reduction in metabolic rate between MCP and Cabosil groups in the light and a  `r coefficients(dark.lm.lean)['Particulate.TreatmentMCP']/coefficients(dark.lm.lean)['(Intercept)']*100`% reduction in the dark.

There was no significant difference between Cabosil and Saline (p=`r summary(dark.lm.lean)$coefficients['Particulate.TreatmentSaline',4]` from a *t* test between linear models).  We therefore repeated this analysis but combined Cabosil and Saline to get more statistical power.

```{r VO2-by-LBM-controls-combined, dev=c('png','pdf')}
#combined the control groups
annotated.data.o2$ParticulateTF <- annotated.data.o2$Particulate.Treatment == 'MCP'

for (row in rownames(annotated.data.o2)) {
  if (annotated.data.o2[row,]$ParticulateTF == TRUE) {
    annotated.data.o2[row,'Particulate'] <- "MCP230"
  }
  else 
    annotated.data.o2[row,'Particulate'] <- "Controls"
}
annotated.data.o2$Particulate <- as.factor(annotated.data.o2$Particulate)

with(annotated.data.o2, plot(Lean, Dark.raw, ylim=c(0,max(Dark.raw)),
                         pch=19, las=2, ylab="VO2 (mL/h)", xlab="Lean Body Mass (g)", main='Dark',col=Particulate))
legend("bottomright", levels(annotated.data.o2$Particulate), pch=19, col=palette()[1:2], lty=1, bty='n')

#anova
dark.lm.lean.ctl <- lm(Dark.raw~Lean+Particulate, data=annotated.data.o2)
dark.aov.lean.ctl <- aov(Dark.raw~Lean+Particulate, data=annotated.data.o2)

abline(a=coefficients(dark.lm.lean.ctl)['(Intercept)'],
       b=coefficients(dark.lm.lean.ctl)['Lean'], col=palette()[1])
abline(a=coefficients(dark.lm.lean.ctl)['(Intercept)']+coefficients(dark.lm.lean.ctl)['ParticulateMCP230'],
       b=coefficients(dark.lm.lean)['Lean'], col=palette()[2])

with(annotated.data.o2, plot(Lean, Light.raw, ylim=c(0,max(Dark.raw)),
                         pch=19, las=2, ylab="VO2 (mL/h)", xlab="Lean Body Mass (g)", main='Light',col=Particulate))
legend("bottomright", levels(annotated.data.o2$Particulate), pch=19, col=palette()[1:2], lty=1, bty='n')
light.lm.lean.ctl <- lm(Light.raw~Lean+Particulate, data=annotated.data.o2)
light.aov.lean.ctl <- aov(Light.raw~Lean+Particulate, data=annotated.data.o2)

abline(a=coefficients(light.lm.lean.ctl)['(Intercept)'],
       b=coefficients(light.lm.lean.ctl)['Lean'], col=palette()[1])
abline(a=coefficients(light.lm.lean.ctl)['(Intercept)']+coefficients(light.lm.lean.ctl)['ParticulateMCP230'],
       b=coefficients(light.lm.lean.ctl)['Lean'], col=palette()[2])

#combined plots
par(mfrow=c(1,2))
with(annotated.data.o2, plot(Lean, Light.raw, ylim=c(0,max(Dark.raw)),
                         pch=19, las=2, ylab="VO2 (mL/h)", xlab="Lean Body Mass (g)", main='Light',col=Particulate))
legend("bottomright", levels(annotated.data.o2$Particulate), pch=19, col=palette()[1:2], lty=1, bty='n')
abline(a=coefficients(light.lm.lean.ctl)['(Intercept)'],
       b=coefficients(light.lm.lean.ctl)['Lean'], col=palette()[1])
abline(a=coefficients(light.lm.lean.ctl)['(Intercept)']+coefficients(light.lm.lean.ctl)['ParticulateMCP230'],
       b=coefficients(light.lm.lean.ctl)['Lean'], col=palette()[2])

with(annotated.data.o2, plot(Lean, Dark.raw, ylim=c(0,max(Dark.raw)),
                         pch=19, las=2, ylab="VO2 (mL/h)", xlab="Lean Body Mass (g)", main='Dark',col=Particulate))
legend("bottomright", levels(annotated.data.o2$Particulate), pch=19, col=palette()[1:2], lty=1, bty='n')
abline(a=coefficients(dark.lm.lean.ctl)['(Intercept)'],
       b=coefficients(dark.lm.lean.ctl)['Lean'], col=palette()[1])
abline(a=coefficients(dark.lm.lean.ctl)['(Intercept)']+coefficients(dark.lm.lean.ctl)['ParticulateMCP230'],
       b=coefficients(dark.lm.lean)['Lean'], col=palette()[2])
```


According to this analysis there was a significant effect of the treatment group on the body weight-adjusted VO2 levels under either Dark (p=`r summary(dark.aov.lean.ctl)[[1]]$"Pr(>F)"[2]`) or Light (p=`r summary(light.aov.lean.ctl)[[1]]$"Pr(>F)"[2]`) conditions.  There was no effect of body weight in either Dark (p=`r summary(dark.aov.lean.ctl)[[1]]$"Pr(>F)"[1]`) or Light (p=`r summary(light.aov.lean.ctl)[[1]]$"Pr(>F)"[1]`) conditions.  Analysed this way, we detected a `r coefficients(light.lm.lean.ctl)['ParticulateMCP230']/coefficients(light.lm.lean.ctl)['(Intercept)']*100`% reduction in metabolic rate between MCP and Control groups in the light and a  `r coefficients(dark.lm.lean.ctl)['ParticulateMCP230']/coefficients(dark.lm.lean.ctl)['(Intercept)']*100`% reduction in the dark.


Alternatively we used a mixed linear model, with non-interacting covariates for the Light cycle, the Lean Body Mass and the Particulate treatment.  A Chi-squared test comparing a model with or without the Particulate treatment yielded a p-value of `r anova(complete.lme.lean, no.treatment.lme.lean)$"Pr(>Chisq)"[2]`.  Post-hoc tests for the effects of particulate treatment are shown in the table below.  According to this MCP treatment reduces VO2 by `r summary(lme.ph.lean, test=adjusted(type='none'))$test$coefficients[4]/summary(lme.ph.lean, test=adjusted(type='none'))$test$coefficients[1]*100`%, p=`r summary(lme.ph.lean, test=adjusted(type='none'))$test$pvalue[4]`.

```{r Dark-Light-Correlation,dev=c('png','pdf')}
with(annotated.data.o2, plot(Light.raw, Dark.raw,
                         ylim=c(0,max(Light.raw)),
                         xlim=c(0,max(Dark.raw)),
                         pch=19, las=1, ylab="Light", xlab="Dark", main='VO2', col=Particulate.Treatment))
legend("bottomleft", levels(annotated.data.o2$Particulate.Treatment), pch=19, col=palette()[1:3], lty=1, bty='n')
dark.light.lm <- lm(Dark.raw~Light.raw, data=combined.data)
abline(dark.light.lm, lty=2, col='red')
```

```{r time-course-o2, dev=c('png','pdf')}
#add control column to sample key
all.data.clean.annotated <- merge(all.data.clean, sample_key, by.x='Subject', by.y='Mouse.ID')
#intervals are 25 mins
interval_time <- 41-16
interval_hours <- interval_time/60
all.data.clean.annotated$Hours <- round((all.data.clean.annotated$Interval-41) * interval_hours)

all.data.clean.annotated$ParticulateTF <- all.data.clean.annotated$Particulate.Treatment == 'MCP'
for (row in rownames(all.data.clean.annotated)) {
  if (all.data.clean.annotated[row,]$ParticulateTF == TRUE) {
    all.data.clean.annotated[row,'Particulate'] <- "MCP230"
  }
  else 
    all.data.clean.annotated[row,'Particulate'] <- "Controls"
}
all.data.clean.annotated$Particulate <- as.factor(all.data.clean.annotated$Particulate)
calorimetry.annotated <- merge(all.data.clean.annotated, mri_data, by.x='Subject', by.y='Label')
calorimetry.annotated$VO2 <- calorimetry.annotated$Volume.O2 * calorimetry.annotated$Weight/1000

library(dplyr)
time.course.data <-
  calorimetry.annotated %>%
  group_by(Hours, Particulate) %>%
  summarize(mean = mean(VO2),
            se = sd(VO2)/sqrt(length(VO2)),
            n = length(VO2),
            mean.lbm = mean(VO2/Lean))

time.course.data.heat <-
  all.data.clean.annotated %>%
  group_by(Hours, Particulate.Treatment) %>%
  summarize(mean = mean(Heat),
            se = sd(Heat)/sqrt(length(Heat)),
            n = length(Heat))

time.course.data.heat.ctl <-
  all.data.clean.annotated %>%
  group_by(Hours, Particulate) %>%
  dplyr::summarize(mean = mean(Heat),
            se = sd(Heat)/sqrt(length(Heat)),
            n = length(Heat))
first_dark_cycle = 7.55

y.axis <- c(min(time.course.data$mean, na.rm=T), max(time.course.data$mean, na.rm=T))
with(subset(time.course.data, Particulate==levels(Particulate)[1]), 
     plot(Hours, mean, type='l', 
          ylim=y.axis, las=1, xlim=c(0,53),
          xlab="Time (h)", ylab="Oxygen Consumption (VO2/mL)"))
#shaded in night times
rect(first_dark_cycle, y.axis[1], first_dark_cycle+12, y.axis[2], col=grey.colors(5)[5])
rect(first_dark_cycle+24, y.axis[1], first_dark_cycle+36, y.axis[2], col=grey.colors(5)[5])
rect(first_dark_cycle+48, y.axis[1], first_dark_cycle+60, y.axis[2], col=grey.colors(5)[5])
with(subset(time.course.data, Particulate==levels(Particulate)[1]), lines(Hours, mean, col=palette()[1]))
with(subset(time.course.data, Particulate==levels(Particulate)[2]), lines(Hours, mean, col=palette()[2]))
legend("topright", levels(time.course.data$Particulate), lty=1, col=palette()[1:2], bty='n')


y.axis <- c(min(time.course.data$mean.lbm, na.rm=T), max(time.course.data$mean.lbm, na.rm=T))
with(subset(time.course.data, Particulate==levels(Particulate)[1]), 
     plot(Hours, mean.lbm, type='l', 
          ylim=y.axis, las=1, xlim=c(0,53),
          xlab="Time (h)", ylab="Oxygen Consumption (VO2/mL/g FFM)"))
#shaded in night times
rect(first_dark_cycle, y.axis[1], first_dark_cycle+12, y.axis[2], col=grey.colors(5)[5])
rect(first_dark_cycle+24, y.axis[1], first_dark_cycle+36, y.axis[2], col=grey.colors(5)[5])
rect(first_dark_cycle+48, y.axis[1], first_dark_cycle+60, y.axis[2], col=grey.colors(5)[5])
with(subset(time.course.data, Particulate==levels(Particulate)[1]), lines(Hours, mean.lbm, col=palette()[1]))
with(subset(time.course.data, Particulate==levels(Particulate)[2]), lines(Hours, mean.lbm, col=palette()[2]))
legend("topright", levels(time.course.data$Particulate), lty=1, col=palette()[1:2], bty='n')

```

## Calorimetry by Heat Production

Another way to present these data is to evaluate this by heat instead of VO2.  The equation for Heat production from the CLAMS is the Lusk Equation:

$$(3.815 + 1.232 * RER)*VO2$$

To analyse these data we performed an ANCOVA analysis using body weight as the primary covariate. 

```{r heat-by-weight,dev=c('png','pdf')}
par(mfrow=c(1,2))
with(annotated.data.heat, plot(Weight, Dark.raw, ylim=c(0,max(Dark.raw)),
                         pch=19, las=2, ylab="Heat Production (kcal/h)", main='Dark', col=Particulate.Treatment))
legend("bottomright", levels(annotated.data.o2$Particulate.Treatment), pch=19, col=palette()[1:3], lty=1, bty='n')

dark.lm <- lm(Dark.raw~Weight+Particulate.Treatment, data=annotated.data.heat)
dark.aov <- aov(Dark.raw~Weight+Particulate.Treatment, data=annotated.data.heat)

abline(a=coefficients(dark.lm)[1],
       b=coefficients(dark.lm)[2], col=palette()[1])
abline(a=coefficients(dark.lm)[1]+coefficients(dark.lm)['Particulate.TreatmentMCP'],
       b=coefficients(dark.lm)[2], col=palette()[2])
abline(a=coefficients(dark.lm)[1]+coefficients(dark.lm)['Particulate.TreatmentSaline'],
       b=coefficients(dark.lm)[2], col=palette()[3])

with(annotated.data.heat, plot(Weight, Light.raw, ylim=c(0,max(Dark.raw)),
                         pch=19, las=2, ylab="Heat Production (kcal/h)", main='Light',col=Particulate.Treatment))
legend("bottomright", levels(annotated.data.o2$Particulate.Treatment), pch=19, col=palette()[1:3], lty=1, bty='n')
light.lm <- lm(Light.raw~Weight+Particulate.Treatment, data=annotated.data.heat)
light.aov <- aov(Light.raw~Weight+Particulate.Treatment, data=annotated.data.heat)

abline(a=coefficients(light.lm)[1],
       b=coefficients(light.lm)[2], col=palette()[1])
abline(a=coefficients(light.lm)[1]+coefficients(light.lm)['Particulate.TreatmentMCP'],
       b=coefficients(light.lm)[2], col=palette()[2])
abline(a=coefficients(light.lm)[1]+coefficients(light.lm)['Particulate.TreatmentSaline'],
       b=coefficients(light.lm)[2], col=palette()[3])

#for heat production
complete.lme.heat <- lmer(Heat ~ Light.Dark + Weight + Particulate.Treatment + (1|Subject), data=full.annotated.data, REML=F)
no.treatment.lme.heat <- lmer(Heat ~ Light.Dark + Weight + (1|Subject), data=full.annotated.data, REML=F)
lme.ph.heat <- glht(complete.lme.heat, infct=mcp(Particulate.Treatment='Dunnett'))
complete.lme.lean.heat <- lmer(Heat ~ Light.Dark + Lean + Particulate.Treatment + (1|Subject), data=full.annotated.data, REML=F)
no.treatment.lme.lean.heat<- lmer(Heat ~ Light.Dark + Lean + (1|Subject), data=full.annotated.data, REML=F)
lme.ph.lean.heat <- glht(complete.lme.lean.heat, infct=mcp(Particulate.Treatment='Dunnett'))
```

We first checked whether normality was maintained in the residuals from the ANCOVA.  The normality assumption was met for both Dark (p=`r shapiro.test(residuals(dark.aov))$p.value`) and Light (p=`r shapiro.test(residuals(light.aov))$p.value`) via Shapiro-Wilk test.  

According to this analysis there was no significant effect of the treatment group on the body weight-adjusted heat production levels under either Dark (p=`r summary(dark.aov)[[1]]$"Pr(>F)"[2]`) or Light (p=`r summary(light.aov)[[1]]$"Pr(>F)"[2]`) conditions.  There was also no significant effect of body weight in either Dark (p=`r summary(dark.aov)[[1]]$"Pr(>F)"[1]`) or Light (p=`r summary(light.aov)[[1]]$"Pr(>F)"[1]`) conditions.  We detected a `r coefficients(light.lm)['Particulate.TreatmentMCP']/coefficients(light.lm)['(Intercept)']*100`% reduction in metabolic rate between MCP and Cabosil groups in the light and a `r coefficients(dark.lm)['Particulate.TreatmentMCP']/coefficients(dark.lm)['(Intercept)']*100`% reduction in the dark.

Alternatively we used a mixed linear model, with non-interacting covariates for the Light cycle, the Weight and the Particulate treatment.  A F-test comparing a model with or without the Particulate treatment yielded a p-value of `r anova(complete.lme, no.treatment.lme.heat)$"Pr(>Chisq)"[2]`.  Post-hoc tests for the effects of particulate treatment are shown in the Table below.  According to this MCP treatment reduces heat production by `r summary(lme.ph.heat, test=adjusted(type='none'))$test$coefficients[4]/summary(lme.ph.heat, test=adjusted(type='none'))$test$coefficients[1]*100`%, p=`r summary(lme.ph.heat, test=adjusted(type='none'))$test$pvalue[4]`.

```{r heat-post-hoc, results='asis'}
tukey.table.heat <- data.frame(
  Coefficient = summary(lme.ph.heat, test=adjusted(type='BH'))$test$coefficients,
  p.value = summary(lme.ph.heat,test=adjusted(type='none'))$test$pvalue[1:5])

print(xtable(tukey.table.heat, caption="Post-hoc Dunnett's tests of mixed linear model correcting for effects of light cycle and total body mass on heat production.  P-values are not corrected.", label='tab:heat-lme-ph', digits=c(0,0,3)), type='html')

tukey.table.lean.heat <- data.frame(
  Coefficient = summary(lme.ph.lean.heat, test=adjusted(type='BH'))$test$coefficients,
  p.value = summary(lme.ph.lean.heat,test=adjusted(type='none'))$test$pvalue[1:5])

print(xtable(tukey.table.lean.heat, caption="Post-hoc Dunnett's sests of mixed linear model correcting for effects of light cycle and lean body mass on heat production.  P-values are not corrected.", label='tab:heat-lme-lean-ph', digits=c(0,0,3)), type='html')
```

## Normalization by Lean Body Mass

```{r heat-by-LBM, dev=c('png','pdf')}
par(mfrow=c(1,2))
with(annotated.data.heat, plot(Lean, Dark.raw, ylim=c(0,max(Dark.raw)),
                         pch=19, las=2, ylab="Heat Production (kcal/h)", main='Dark',col=Particulate.Treatment))
legend("bottomright", levels(annotated.data.heat$Particulate.Treatment), pch=19, col=palette()[1:3], lty=1, bty='n')

#anova
dark.lm.lean <- lm(Dark.raw~Lean+Particulate.Treatment, data=annotated.data.heat)
dark.aov.lean <- aov(Dark.raw~Lean+Particulate.Treatment, data=annotated.data.heat)

abline(a=coefficients(dark.lm.lean)[1],
       b=coefficients(dark.lm.lean)[2], col=palette()[1])
abline(a=coefficients(dark.lm.lean)[1]+coefficients(dark.lm.lean)['Particulate.TreatmentMCP'],
       b=coefficients(dark.lm.lean)[2], col=palette()[2])
abline(a=coefficients(dark.lm.lean)[1]+coefficients(dark.lm.lean)['Particulate.TreatmentSaline'],
       b=coefficients(dark.lm.lean)[2], col=palette()[3])
#superpose.eb(combined.data$Lean, combined.data$Dark.raw, combined.data.err$Dark.raw)

with(annotated.data.heat, plot(Lean, Light.raw, ylim=c(0,max(Dark.raw)),
                         pch=19, las=2, ylab="Heat Production (kcal/h)", main='Light',col=Particulate.Treatment))
legend("bottomright", levels(annotated.data.heat$Particulate.Treatment), pch=19, col=palette()[1:3], lty=1, bty='n')
light.lm.lean <- lm(Light.raw~Lean+Particulate.Treatment, data=annotated.data.heat)
light.aov.lean <- aov(Light.raw~Lean+Particulate.Treatment, data=annotated.data.heat)

abline(a=coefficients(light.lm.lean)[1],
       b=coefficients(light.lm.lean)[2], col=palette()[1])
abline(a=coefficients(light.lm.lean)[1]+coefficients(light.lm.lean)['Particulate.TreatmentMCP'],
       b=coefficients(light.lm.lean)[2], col=palette()[2])
abline(a=coefficients(light.lm.lean)[1]+coefficients(light.lm.lean)['Particulate.TreatmentSaline'],
       b=coefficients(light.lm.lean)[2], col=palette()[3])
#superpose.eb(combined.data$Lean, combined.data$Light.raw, combined.data.err$Dark.raw)
```

Using the lean mass as the covariate, we checked whether normality was maintained in the residuals from the ANCOVA.  The normality assumption was met for both Dark (p=`r shapiro.test(residuals(dark.aov.lean))$p.value`) and Light (p=`r shapiro.test(residuals(light.aov.lean))$p.value`) via Shapiro-Wilk test.  

According to this analysis there was no significant effect of the treatment group on the body weight-adjusted heat produciton levels under either Dark (p=`r summary(dark.aov.lean)[[1]]$"Pr(>F)"[2]`) or Light (p=`r summary(light.aov.lean)[[1]]$"Pr(>F)"[2]`) conditions.  There was also no effect of body weight in either Dark (p=`r summary(dark.aov.lean)[[1]]$"Pr(>F)"[1]`) or Light (p=`r summary(light.aov.lean)[[1]]$"Pr(>F)"[1]`) conditions.  Analysed this way, we detected a `r coefficients(light.lm.lean)['Particulate.TreatmentMCP']/coefficients(light.lm.lean)['(Intercept)']*100`% reduction in metabolic rate between MCP and Cabosil groups in the light and a  `r coefficients(dark.lm.lean)['Particulate.TreatmentMCP']/coefficients(dark.lm.lean)['(Intercept)']*100`% reduction in the dark.

There was no significant difference between Cabosil and Saline (p=`r summary(dark.lm.lean)$coefficients['Particulate.TreatmentSaline',4]` from a *t* test between linear models).  We therefore repeated this analysis but combined Cabosil and Saline to get more statistical power.

```{r heat-by-LBM-controls-combined, dev=c('png','pdf')}
#combined the control groups
annotated.data.heat$ParticulateTF <- annotated.data.heat$Particulate.Treatment == 'MCP'

for (row in rownames(annotated.data.heat)) {
  if (annotated.data.heat[row,]$ParticulateTF == TRUE) {
    annotated.data.heat[row,'Particulate'] <- "MCP230"
  }
  else 
    annotated.data.heat[row,'Particulate'] <- "Controls"
}
annotated.data.heat$Particulate <- as.factor(annotated.data.heat$Particulate)

with(annotated.data.heat, plot(Lean, Dark.raw, ylim=c(0,max(Dark.raw)),
                         pch=19, las=2, ylab="Heat Production (kcal/h)", xlab="Lean Body Mass (g)", main='Dark',col=Particulate))
legend("bottomright", levels(annotated.data.heat$Particulate), pch=19, col=palette()[1:2], lty=1, bty='n')

#anova
dark.lm.lean.ctl <- lm(Dark.raw~Lean+Particulate, data=annotated.data.heat)
dark.aov.lean.ctl <- aov(Dark.raw~Lean+Particulate, data=annotated.data.heat)

abline(a=coefficients(dark.lm.lean.ctl)['(Intercept)'],
       b=coefficients(dark.lm.lean.ctl)['Lean'], col=palette()[1])
abline(a=coefficients(dark.lm.lean.ctl)['(Intercept)']+coefficients(dark.lm.lean.ctl)['ParticulateMCP230'],
       b=coefficients(dark.lm.lean)['Lean'], col=palette()[2])

with(annotated.data.heat, plot(Lean, Light.raw, ylim=c(0,max(Dark.raw)),
                         pch=19, las=2, ylab="Heat Production (kcal/h)", xlab="Lean Body Mass (g)", main='Light',col=Particulate))
legend("bottomright", levels(annotated.data.heat$Particulate), pch=19, col=palette()[1:2], lty=1, bty='n')
light.lm.lean.ctl <- lm(Light.raw~Lean+Particulate, data=annotated.data.heat)
light.aov.lean.ctl <- aov(Light.raw~Lean+Particulate, data=annotated.data.heat)

abline(a=coefficients(light.lm.lean.ctl)['(Intercept)'],
       b=coefficients(light.lm.lean.ctl)['Lean'], col=palette()[1])
abline(a=coefficients(light.lm.lean.ctl)['(Intercept)']+coefficients(light.lm.lean.ctl)['ParticulateMCP230'],
       b=coefficients(light.lm.lean.ctl)['Lean'], col=palette()[2])

#combined plots
par(mfrow=c(1,2))
with(annotated.data.heat, plot(Lean, Light.raw, ylim=c(0,max(Dark.raw)),
                         pch=19, las=2, ylab="Heat Production (kcal/h)", xlab="Lean Body Mass (g)", main='Light',col=Particulate))
legend("bottomright", levels(annotated.data.o2$Particulate), pch=19, col=palette()[1:2], lty=1, bty='n')
abline(a=coefficients(light.lm.lean.ctl)['(Intercept)'],
       b=coefficients(light.lm.lean.ctl)['Lean'], col=palette()[1])
abline(a=coefficients(light.lm.lean.ctl)['(Intercept)']+coefficients(light.lm.lean.ctl)['ParticulateMCP230'],
       b=coefficients(light.lm.lean.ctl)['Lean'], col=palette()[2])

with(annotated.data.heat, plot(Lean, Dark.raw, ylim=c(0,max(Dark.raw)),
                         pch=19, las=2, ylab="Heat Produciton (kcal/h)", xlab="Lean Body Mass (g)", main='Dark',col=Particulate))
legend("bottomright", levels(annotated.data.heat$Particulate), pch=19, col=palette()[1:2], lty=1, bty='n')
abline(a=coefficients(dark.lm.lean.ctl)['(Intercept)'],
       b=coefficients(dark.lm.lean.ctl)['Lean'], col=palette()[1])
abline(a=coefficients(dark.lm.lean.ctl)['(Intercept)']+coefficients(dark.lm.lean.ctl)['ParticulateMCP230'],
       b=coefficients(dark.lm.lean.ctl)['Lean'], col=palette()[2])

#Heat as Watts
par(mfrow=c(1,1))
annotated.data.heat$Dark.watts <- annotated.data.heat$Dark.raw*60/4184*1000 #x 60 to get kcal/s and divided by 1 kcal/s is 4184 watts x 1000 to get mW
annotated.data.heat$Light.watts <- annotated.data.heat$Light.raw*60/4184*1000 #x 60 to get kcal/s and divided by 1 kcal/s is 4184 watts x 1000 to get mW
  
with(annotated.data.heat, plot(Lean, Dark.watts, ylim=c(0,max(Dark.watts)),
                         pch=19, las=2, ylab="Heat Production (mW)", xlab="Lean Body Mass (g)", main='Dark',col=Particulate))
legend("bottomright", levels(annotated.data.heat$Particulate), pch=19, col=palette()[1:2], lty=1, bty='n')

#anova
dark.lm.lean.ctl <- lm(Dark.watts~Lean+Particulate, data=annotated.data.heat)
dark.aov.lean.ctl <- aov(Dark.watts~Lean+Particulate, data=annotated.data.heat)

abline(a=coefficients(dark.lm.lean.ctl)['(Intercept)'],
       b=coefficients(dark.lm.lean.ctl)['Lean'], col=palette()[1])
abline(a=coefficients(dark.lm.lean.ctl)['(Intercept)']+coefficients(dark.lm.lean.ctl)['ParticulateMCP230'],
       b=coefficients(dark.lm.lean.ctl)['Lean'], col=palette()[2])

with(annotated.data.heat, plot(Lean, Light.watts, ylim=c(0,max(Dark.watts)),
                         pch=19, las=2, ylab="Heat Production (mW)", xlab="Lean Body Mass (g)", main='Light',col=Particulate))
legend("bottomright", levels(annotated.data.heat$Particulate), pch=19, col=palette()[1:2], lty=1, bty='n')
light.lm.lean.ctl <- lm(Light.watts~Lean+Particulate, data=annotated.data.heat)
light.aov.lean.ctl <- aov(Light.watts~Lean+Particulate, data=annotated.data.heat)

abline(a=coefficients(light.lm.lean.ctl)['(Intercept)'],
       b=coefficients(light.lm.lean.ctl)['Lean'], col=palette()[1])
abline(a=coefficients(light.lm.lean.ctl)['(Intercept)']+coefficients(light.lm.lean.ctl)['ParticulateMCP230'],
       b=coefficients(light.lm.lean.ctl)['Lean'], col=palette()[2])

#combined plots
par(mfrow=c(1,2))
with(annotated.data.heat, plot(Lean, Light.watts, ylim=c(0,max(Dark.watts)),
                         pch=19, las=2, ylab="Heat Production (mW)", xlab="Lean Body Mass (g)", main='Light',col=Particulate))
legend("bottomright", levels(annotated.data.o2$Particulate), pch=19, col=palette()[1:2], lty=1, bty='n')
abline(a=coefficients(light.lm.lean.ctl)['(Intercept)'],
       b=coefficients(light.lm.lean.ctl)['Lean'], col=palette()[1])
abline(a=coefficients(light.lm.lean.ctl)['(Intercept)']+coefficients(light.lm.lean.ctl)['ParticulateMCP230'],
       b=coefficients(light.lm.lean.ctl)['Lean'], col=palette()[2])

with(annotated.data.heat, plot(Lean, Dark.watts, ylim=c(0,max(Dark.watts)),
                         pch=19, las=2, ylab="Heat Produciton (mW)", xlab="Lean Body Mass (g)", main='Dark',col=Particulate))
legend("bottomright", levels(annotated.data.heat$Particulate), pch=19, col=palette()[1:2], lty=1, bty='n')
abline(a=coefficients(dark.lm.lean.ctl)['(Intercept)'],
       b=coefficients(dark.lm.lean.ctl)['Lean'], col=palette()[1])
abline(a=coefficients(dark.lm.lean.ctl)['(Intercept)']+coefficients(dark.lm.lean.ctl)['ParticulateMCP230'],
       b=coefficients(dark.lm.lean.ctl)['Lean'], col=palette()[2])


#Heat as kJ/h
annotated.data.heat$Dark.kj<- annotated.data.heat$Dark.raw / 4.184 * 1000  #x 4.184 to go from kcal to kJ, *1000 to get to J
annotated.data.heat$Light.kj <- annotated.data.heat$Light.raw / 4.184 * 1000  #x 60 to get kcal/s and divided by 1 kcal/s is 4184 watts x 1000 to get mW
  
par(mfrow=c(1,1))
with(annotated.data.heat, plot(Lean, Dark.kj, ylim=c(0,max(Dark.kj)),
                         pch=19, las=2, ylab="Heat Production (J/h)", xlab="Lean Body Mass (g)", main='Dark',col=Particulate))
legend("bottomright", levels(annotated.data.heat$Particulate), pch=19, col=palette()[1:2], lty=1, bty='n')

#anova
dark.lm.lean.ctl <- lm(Dark.kj~Lean+Particulate, data=annotated.data.heat)
dark.aov.lean.ctl <- aov(Dark.kj~Lean+Particulate, data=annotated.data.heat)

abline(a=coefficients(dark.lm.lean.ctl)['(Intercept)'],
       b=coefficients(dark.lm.lean.ctl)['Lean'], col=palette()[1])
abline(a=coefficients(dark.lm.lean.ctl)['(Intercept)']+coefficients(dark.lm.lean.ctl)['ParticulateMCP230'],
       b=coefficients(dark.lm.lean.ctl)['Lean'], col=palette()[2])

with(annotated.data.heat, plot(Lean, Light.kj, ylim=c(0,max(Dark.kj)),
                         pch=19, las=2, ylab="Heat Production (J/h)", xlab="Lean Body Mass (g)", main='Light',col=Particulate))
legend("bottomright", levels(annotated.data.heat$Particulate), pch=19, col=palette()[1:2], lty=1, bty='n')
light.lm.lean.ctl <- lm(Light.kj~Lean+Particulate, data=annotated.data.heat)
light.aov.lean.ctl <- aov(Light.kj~Lean+Particulate, data=annotated.data.heat)

abline(a=coefficients(light.lm.lean.ctl)['(Intercept)'],
       b=coefficients(light.lm.lean.ctl)['Lean'], col=palette()[1])
abline(a=coefficients(light.lm.lean.ctl)['(Intercept)']+coefficients(light.lm.lean.ctl)['ParticulateMCP230'],
       b=coefficients(light.lm.lean.ctl)['Lean'], col=palette()[2])

#combined plots
par(mfrow=c(1,2))
with(annotated.data.heat, plot(Lean, Light.kj, ylim=c(0,max(Dark.kj)),
                         pch=19, las=2, ylab="Heat Production (J/h)", xlab="Lean Body Mass (g)", main='Light',col=Particulate))
legend("bottomright", levels(annotated.data.o2$Particulate), pch=19, col=palette()[1:2], lty=1, bty='n')
abline(a=coefficients(light.lm.lean.ctl)['(Intercept)'],
       b=coefficients(light.lm.lean.ctl)['Lean'], col=palette()[1])
abline(a=coefficients(light.lm.lean.ctl)['(Intercept)']+coefficients(light.lm.lean.ctl)['ParticulateMCP230'],
       b=coefficients(light.lm.lean.ctl)['Lean'], col=palette()[2])

with(annotated.data.heat, plot(Lean, Dark.kj, ylim=c(0,max(Dark.kj)),
                         pch=19, las=2, ylab="Heat Produciton (J/h)", xlab="Lean Body Mass (g)", main='Dark',col=Particulate))
legend("bottomright", levels(annotated.data.heat$Particulate), pch=19, col=palette()[1:2], lty=1, bty='n')
abline(a=coefficients(dark.lm.lean.ctl)['(Intercept)'],
       b=coefficients(dark.lm.lean.ctl)['Lean'], col=palette()[1])
abline(a=coefficients(dark.lm.lean.ctl)['(Intercept)']+coefficients(dark.lm.lean.ctl)['ParticulateMCP230'],
       b=coefficients(dark.lm.lean.ctl)['Lean'], col=palette()[2])
```


According to this analysis there was a significant effect of the treatment group on the body weight-adjusted heat produciton levels under either Dark (p=`r summary(dark.aov.lean.ctl)[[1]]$"Pr(>F)"[2]`) or Light (p=`r summary(light.aov.lean.ctl)[[1]]$"Pr(>F)"[2]`) conditions.  There was no effect of body weight in either Dark (p=`r summary(dark.aov.lean.ctl)[[1]]$"Pr(>F)"[1]`) or Light (p=`r summary(light.aov.lean.ctl)[[1]]$"Pr(>F)"[1]`) conditions.  Analysed this way, we detected a `r coefficients(light.lm.lean.ctl)['ParticulateMCP230']/coefficients(light.lm.lean.ctl)['(Intercept)']*100`% reduction in metabolic rate between MCP and Control groups in the light and a  `r coefficients(dark.lm.lean.ctl)['ParticulateMCP230']/coefficients(dark.lm.lean.ctl)['(Intercept)']*100`% reduction in the dark.


Alternatively we used a mixed linear model, with non-interacting covariates for the Light cycle, the Lean Body Mass and the Particulate treatment.  A Chi-squared test comparing a model with or without the Particulate treatment yielded a p-value of `r anova(complete.lme.lean.heat, no.treatment.lme.lean.heat)$"Pr(>Chisq)"[2]`.  Post-hoc tests for the effects of particulate treatment are shown in the table below.  According to this MCP treatment reduces heat production by `r summary(lme.ph.lean.heat, test=adjusted(type='none'))$test$coefficients[4]/summary(lme.ph.lean.heat, test=adjusted(type='none'))$test$coefficients[1]*100`%, p=`r summary(lme.ph.lean.heat, test=adjusted(type='none'))$test$pvalue[4]`.

```{r time-course-heat, dev=c('png','pdf')}
y.axis <- c(min(time.course.data.heat$mean, na.rm=T), max(time.course.data.heat$mean, na.rm=T))
with(subset(time.course.data.heat, Particulate.Treatment==levels(Particulate.Treatment)[1]), 
     plot(Hours, mean, type='l', 
          ylim=y.axis, las=1, xlim=c(0,53),
          xlab="Time (h)", ylab="Heat Production (kcal/h)"))
#shaded in night times
first_dark_cycle = 7.55
rect(first_dark_cycle, y.axis[1], first_dark_cycle+12, y.axis[2], col=grey.colors(5)[5])
rect(first_dark_cycle+24, y.axis[1], first_dark_cycle+36, y.axis[2], col=grey.colors(5)[5])
rect(first_dark_cycle+48, y.axis[1], first_dark_cycle+60, y.axis[2], col=grey.colors(5)[5])
with(subset(time.course.data.heat, Particulate.Treatment==levels(Particulate.Treatment)[1]), lines(Hours, mean, col=palette()[1]))
with(subset(time.course.data.heat, Particulate.Treatment==levels(Particulate.Treatment)[2]), lines(Hours, mean, col=palette()[2]))
with(subset(time.course.data.heat, Particulate.Treatment==levels(Particulate.Treatment)[3]), lines(Hours, mean, col=palette()[3]))
legend("topright", levels(time.course.data.heat$Particulate.Treatment), lty=1, col=palette()[1:3], bty='n')

#presented in Watts
time.course.data.heat$mean.watts <- time.course.data.heat$mean * 60 / 4184 * 1000 #convert to seconds then Watts
y.axis <- c(min(time.course.data.heat$mean.watts, na.rm=T), max(time.course.data.heat$mean.watts, na.rm=T))
with(subset(time.course.data.heat, Particulate.Treatment==levels(Particulate.Treatment)[1]), 
     plot(Hours, mean.watts, type='l', 
          ylim=y.axis, las=1, xlim=c(0,53),
          xlab="Time (h)", ylab="Heat Production (mW)"))
#shaded in night times
rect(first_dark_cycle, y.axis[1], first_dark_cycle+12, y.axis[2], col=grey.colors(5)[5])
rect(first_dark_cycle+24, y.axis[1], first_dark_cycle+36, y.axis[2], col=grey.colors(5)[5])
rect(first_dark_cycle+48, y.axis[1], first_dark_cycle+60, y.axis[2], col=grey.colors(5)[5])
with(subset(time.course.data.heat, Particulate.Treatment==levels(Particulate.Treatment)[1]), lines(Hours, mean.watts, col=palette()[1]))
with(subset(time.course.data.heat, Particulate.Treatment==levels(Particulate.Treatment)[2]), lines(Hours, mean.watts, col=palette()[2]))
with(subset(time.course.data.heat, Particulate.Treatment==levels(Particulate.Treatment)[3]), lines(Hours, mean.watts, col=palette()[3]))
legend("topright", levels(time.course.data.heat$Particulate.Treatment), lty=1, col=palette()[1:3], bty='n')

#combining the controls
y.axis <- c(min(time.course.data.heat.ctl$mean, na.rm=T), max(time.course.data.heat.ctl$mean, na.rm=T))
with(subset(time.course.data.heat.ctl, Particulate==levels(Particulate)[1]), 
     plot(Hours, mean, type='l', 
          ylim=y.axis, las=1, xlim=c(0,53),
          xlab="Time (h)", ylab="Heat Production (kcal/h)"))
#shaded in night times
rect(first_dark_cycle, y.axis[1], first_dark_cycle+12, y.axis[2], col=grey.colors(5)[5])
rect(first_dark_cycle+24, y.axis[1], first_dark_cycle+36, y.axis[2], col=grey.colors(5)[5])
rect(first_dark_cycle+48, y.axis[1], first_dark_cycle+60, y.axis[2], col=grey.colors(5)[5])
with(subset(time.course.data.heat.ctl, Particulate==levels(Particulate)[1]), lines(Hours, mean, col=palette()[1]))
with(subset(time.course.data.heat.ctl, Particulate==levels(Particulate)[2]), lines(Hours, mean, col=palette()[2]))
legend("topright", levels(time.course.data.heat.ctl$Particulate), lty=1, col=palette()[1:2], bty='n')

#presented in Watts
time.course.data.heat.ctl$mean.watts <- time.course.data.heat.ctl$mean * 60 / 4184 * 1000 #convert to seconds then Watts
y.axis <- c(min(time.course.data.heat.ctl$mean.watts, na.rm=T), max(time.course.data.heat.ctl$mean.watts, na.rm=T))
with(subset(time.course.data.heat.ctl, Particulate==levels(Particulate)[1]), 
     plot(Hours, mean.watts, type='l', 
          ylim=y.axis, las=1, xlim=c(0,53),
          xlab="Time (h)", ylab="Heat Production (mW)"))
#shaded in night times
rect(first_dark_cycle, y.axis[1], first_dark_cycle+12, y.axis[2], col=grey.colors(5)[5])
rect(first_dark_cycle+24, y.axis[1], first_dark_cycle+36, y.axis[2], col=grey.colors(5)[5])
rect(first_dark_cycle+48, y.axis[1], first_dark_cycle+60, y.axis[2], col=grey.colors(5)[5])
with(subset(time.course.data.heat.ctl, Particulate==levels(Particulate)[1]), lines(Hours, mean.watts, col=palette()[1]))
with(subset(time.course.data.heat.ctl, Particulate==levels(Particulate)[2]), lines(Hours, mean.watts, col=palette()[2]))
legend("topright", levels(time.course.data.heat.ctl$Particulate), lty=1, col=palette()[1:2], bty='n')


#presented in J
time.course.data.heat.ctl$mean.j <- time.course.data.heat.ctl$mean * 4.184 * 1000 #convert to seconds then Watts
y.axis <- c(min(time.course.data.heat.ctl$mean.j, na.rm=T), max(time.course.data.heat.ctl$mean.j, na.rm=T))
with(subset(time.course.data.heat.ctl, Particulate==levels(Particulate)[1]), 
     plot(Hours, mean.j, type='l', 
          ylim=y.axis, las=1, xlim=c(0,53),
          xlab="Time (h)", ylab="Heat Production (J/h)"))
#shaded in night times
rect(first_dark_cycle, y.axis[1], first_dark_cycle+12, y.axis[2], col=grey.colors(5)[5])
rect(first_dark_cycle+24, y.axis[1], first_dark_cycle+36, y.axis[2], col=grey.colors(5)[5])
rect(first_dark_cycle+48, y.axis[1], first_dark_cycle+60, y.axis[2], col=grey.colors(5)[5])
with(subset(time.course.data.heat.ctl, Particulate==levels(Particulate)[1]), lines(Hours, mean.j, col=palette()[1]))
with(subset(time.course.data.heat.ctl, Particulate==levels(Particulate)[2]), lines(Hours, mean.j, col=palette()[2]))
legend("topright", levels(time.course.data.heat.ctl$Particulate), lty=1, col=palette()[1:2], bty='n')
```

# Body Weights and Composition

```{r body-composition,dev=c('png','pdf')}
library(plyr)
annotated.data.o2$Pct.Fat <- annotated.data.o2$Fat/annotated.data.o2$Weight*100
composition.summary <- ddply(annotated.data.o2, ~Particulate.Treatment, summarize,
                            Total.mean = mean(Weight),
                            Total.sd = sd(Weight),
                            Total.se = se(Weight),
                            Lean.mean = mean(Lean),
                            Lean.sd = sd(Lean),
                            Lean.se = se(Lean),
                            Fat.mean = mean(Fat),
                            Fat.sd = sd(Fat),
                            Fat.se = se(Fat),
                            Pct.Fat.mean = mean(Pct.Fat),
                            Pct.Fat.sd = sd(Pct.Fat),
                            Pct.Fat.se = se(Pct.Fat),
                            n = length(Fat))
par(mfrow=c(1,2))
ymax = max(composition.summary$Lean.mean) + max(composition.summary$Lean.se)
plot <- barplot(cbind(composition.summary$Fat.mean, composition.summary$Lean.mean), 
        beside=T, col=palette()[1:3], las=1,
        ylab="Weight (g)", ylim=c(0,ymax),
        names.arg=c("Fat Mass", "Lean Mass"))
superpose.eb(plot, cbind(composition.summary$Fat.mean, composition.summary$Lean.mean),
             cbind(composition.summary$Fat.se, composition.summary$Lean.se))

ymax = max(composition.summary$Pct.Fat.mean) + max(composition.summary$Pct.Fat.se)
plot <- barplot(composition.summary$Pct.Fat.mean, ylab="Percent Fat Mass",
                col=palette()[1:3], las=2, ylim=c(0,ymax),
                names.arg= composition.summary$Particulate.Treatment)
superpose.eb(plot, composition.summary$Pct.Fat.mean,
            composition.summary$Pct.Fat.se)

total.mass.aov <- aov(Weight~Particulate.Treatment, data=annotated.data.o2)
fat.mass.aov <- aov(Fat~Particulate.Treatment, data=annotated.data.o2)
lean.mass.aov <- aov(Lean~Particulate.Treatment, data=annotated.data.o2)
pct.fat.mass.aov <- aov(Pct.Fat~Particulate.Treatment, data=annotated.data.o2)

library(car)
total.mass.levene <- leveneTest(Weight~Particulate.Treatment, data=annotated.data.o2)
fat.mass.levene <- leveneTest(Fat~Particulate.Treatment, data=annotated.data.o2)
lean.mass.levene <- leveneTest(Lean~Particulate.Treatment, data=annotated.data.o2)
pct.fat.mass.levene <- leveneTest(Pct.Fat~Particulate.Treatment, data=annotated.data.o2)

total.mass.kw <- kruskal.test(Weight~Particulate.Treatment, data=annotated.data.o2)
fat.mass.kw <- kruskal.test(Fat~Particulate.Treatment, data=annotated.data.o2)
lean.mass.kw <- kruskal.test(Lean~Particulate.Treatment, data=annotated.data.o2)
pct.fat.mass.kw <- kruskal.test(Pct.Fat~Particulate.Treatment, data=annotated.data.o2)
```

The assumptions of normality were met via a Shapiro-Wilk Test for Total Mass (p=`r shapiro.test(residuals(total.mass.aov))$p.value`), and Lean Mass (p=`r shapiro.test(residuals(lean.mass.aov))$p.value`).  The assumptions of equal varaince were met for Total Mass (p=`r total.mass.levene$"Pr(>F)"[1]`), and Lean Mass (p=`r lean.mass.levene$"Pr(>F)"[1]`.  Based on this there was no significant differentces in Total Mass (p=`r summary(total.mass.aov)[[1]]$"Pr(>F)"[1]`) or Lean Mass (p=`r summary(lean.mass.aov)[[1]]$"Pr(>F)"[1]`) by ANOVA.

These assumptions or normality were not met for Fat Mass (p=`r shapiro.test(residuals(fat.mass.aov))$p.value`) or Percent Fat Mass (p=`r shapiro.test(residuals(pct.fat.mass.aov))$p.value`), so we did Kruskal-Wallis tests instead.  According to these tests there was no significant differences in these groups either for Fat Mass (p=`r fat.mass.kw $p.value`) or Percent Fat Mass (p=`r pct.fat.mass.kw $p.value`).

# Respiratory Exchange Rate

```{r rer, dev=c('png','pdf')}
rer.summary <- ddply(RER.data.annotated, ~Particulate.Treatment, summarize,
                     Dark.mean = mean(Dark),
                     Dark.sd = sd(Dark),
                     Dark.se = se(Dark),
                     Light.mean = mean(Light),
                     Light.sd = sd(Light),
                     Light.se = se(Light))

ymax = max(rer.summary$Dark.mean) + max(rer.summary$Dark.se)
plot <- barplot(cbind(rer.summary$Dark.mean, rer.summary$Light.mean), ylim=c(0.7,1),
        beside=T, col=palette()[1:3], las=1,xpd=FALSE,
        ylab="Respiratory Exchange Ratio",
        names.arg=c("Dark", "Light"))
axis(side=1,at=plot, labels=FALSE, tick=FALSE)

legend("topright", levels(rer.summary$Particulate.Treatment), fill=palette()[1:3], bty='n')
superpose.eb(plot,
             cbind(rer.summary$Dark.mean, rer.summary$Light.mean),
             cbind(rer.summary$Dark.se, rer.summary$Light.se))

rer.light.aov <- aov(Light~Particulate.Treatment, data=RER.data.annotated)
rer.light.kw <- kruskal.test(Light~Particulate.Treatment, data=RER.data.annotated)
rer.light.levene <- leveneTest(Light~Particulate.Treatment, data=RER.data.annotated)

rer.dark.aov <- aov(Dark~Particulate.Treatment, data=RER.data.annotated)
rer.dark.kw <- kruskal.test(Dark~Particulate.Treatment, data=RER.data.annotated)
rer.dark.levene <- leveneTest(Dark~Particulate.Treatment, data=RER.data.annotated)
```

The assumptions of normality was not met for either Light (p=`r shapiro.test(residuals(rer.light.aov))$p.value`) or Dark RER (p=`r shapiro.test(residuals(rer.dark.aov))$p.value`) levels via a Shapiro-Wilk test.  We therefore did a Kruskal-Wallis test and found that while Dark (p=`r rer.dark.kw$p.value`) RER levels not were significantly different, Light RER levels were (p=`r rer.light.kw$p.value`).  Post-hoc tests for Light RER levels are shown in the Table below:

```{r rer-summary, results='asis'}
print(xtable(with(RER.data.annotated, pairwise.wilcox.test(Light, Particulate.Treatment, p.adjust.method='BH'))$p.value, caption = "Pairwise Wilcoxon Rank-Sum Tests, corrected by Benjamini-Hochberg", label="tab:light-rer-ph", digits=4),type='html')
```

# Activity Data

```{r activity, dev=c('png','pdf')}
activity.summary <- ddply(Activity.data.annotated, ~Particulate.Treatment, summarize,
                     Dark.mean = mean(Dark),
                     Dark.sd = sd(Dark),
                     Dark.se = se(Dark),
                     Light.mean = mean(Light),
                     Light.sd = sd(Light),
                     Light.se = se(Light))

ymax = max(activity.summary$Dark.mean) + max(activity.summary$Dark.se)
plot <- barplot(cbind(activity.summary$Dark.mean, activity.summary$Light.mean), ylim=c(0,ymax),
        beside=T, col=palette()[1:3], las=1,
        ylab="Activity",
        names.arg=c("Dark", "Light"))

legend("topright", levels(activity.summary$Particulate.Treatment), fill=palette()[1:3], bty='n')
superpose.eb(plot,
             cbind(activity.summary$Dark.mean, activity.summary$Light.mean),
             cbind(activity.summary$Dark.se, activity.summary$Light.se))

activity.light.aov <- aov(Light~Particulate.Treatment, data=Activity.data.annotated)
activity.light.kw <- kruskal.test(Light~Particulate.Treatment, data=Activity.data.annotated)
activity.light.levene <- leveneTest(Light~Particulate.Treatment, data=Activity.data.annotated)

activity.dark.aov <- aov(Dark~Particulate.Treatment, data=Activity.data.annotated)
activity.dark.kw <- kruskal.test(Dark~Particulate.Treatment, data=Activity.data.annotated)
activity.dark.levene <- leveneTest(Dark~Particulate.Treatment, data=Activity.data.annotated)
```

The assumptions of normality was met for both Light (p=`r shapiro.test(residuals(activity.light.aov))$p.value`) or Dark activity (p=`r shapiro.test(residuals(activity.dark.aov))$p.value`) levels via a Shapiro-Wilk test.  As for the assumptions of equal variance, both Dark (p=`r activity.dark.levene$"Pr(>F)"[1]`), and Light activity levels (p=`r activity.light.levene$"Pr(>F)"[1]`) met this assumption via Levene's test.  We therefore did an ANOVA and found that while Dark (p=`r summary(activity.dark.aov)[[1]]$"Pr(>F)"[1]`) activity levels not were significantly different, Light activity levels were (p=`r summary(activity.light.aov)[[1]]$"Pr(>F)"[1]`).  Post-hoc tests for Light activity levels are shown in the table below:

```{r activity-summary, results='asis'}
library(xtable)

print(xtable(with(Activity.data.annotated, pairwise.t.test(Light, Particulate.Treatment, p.adjust.method='BH', pool.sd=T, var.eq=T))$p.value, caption = "Pairwise Student's T-Tests, corrected by Benjamini-Hochberg", label="tab:light-activity-ph", digits=4), type='html')
```

Since the cabosil and saline treated groups were not significantly different (p=`r with(subset(Activity.data.annotated, Particulate.Treatment != 'MCP'), t.test(Light~Particulate.Treatment), var.equal=T)$p.value`), we combined these groups.

```{r activity-controls-combined, dev=c('png','pdf')}
#combined the control groups
Activity.data.annotated$ParticulateTF <- Activity.data.annotated$Particulate.Treatment == 'MCP'

for (row in rownames(Activity.data.annotated)) {
  if (Activity.data.annotated[row,]$ParticulateTF == TRUE) {
    Activity.data.annotated[row,'Particulate'] <- "MCP230"
  }
  else 
    Activity.data.annotated[row,'Particulate'] <- "Controls"
}

activity.summary.ctl <- ddply(Activity.data.annotated, ~Particulate, summarize,
                     Dark.mean = mean(Dark),
                     Dark.sd = sd(Dark),
                     Dark.se = se(Dark),
                     Light.mean = mean(Light),
                     Light.sd = sd(Light),
                     Light.se = se(Light),
                     shapiro.light = shapiro.test(Dark)$p.value,
                     shapiro.dark = shapiro.test(Light)$p.value)

ymax = max(activity.summary.ctl$Dark.mean) + max(activity.summary.ctl$Dark.se)
plot <- barplot(cbind(activity.summary.ctl$Dark.mean, activity.summary.ctl$Light.mean), ylim=c(0,ymax),
        beside=T, col=palette()[1:2], las=1,
        ylab="Activity",
        names.arg=c("Dark", "Light"))

legend("topright", activity.summary.ctl$Particulate, fill=palette()[1:2], bty='n')
superpose.eb(plot,
             cbind(activity.summary.ctl$Dark.mean, activity.summary.ctl$Light.mean),
             cbind(activity.summary.ctl$Dark.se, activity.summary.ctl$Light.se))
```


After combining these groups, the assumptions of normality (Dark p > `r min(activity.summary.ctl$shapiro.dark)`; Light `r min(activity.summary.ctl$shapiro.light)`) and equal variance were still (Dark p=`r leveneTest(Dark~Particulate, data=Activity.data.annotated)$"Pr(>F)"[1]`; Light p=`r leveneTest(Light~Particulate, data=Activity.data.annotated)$"Pr(>F)"[1]`) met.

Based on these data, there was a `r with(activity.summary.ctl, (Dark.mean[2]-Dark.mean[1])/Dark.mean[1])*100` % reduction in activity in the dark phase (p=`r t.test(Dark~Particulate, data=Activity.data.annotated, var.equal=T)$p.value`) and a `r with(activity.summary.ctl, (Light.mean[2]-Light.mean[1])/Light.mean[1])*100` % reduction in activity in the light phase (p=`r t.test(Light~Particulate, data=Activity.data.annotated, var.equal=T)$p.value`).

# Food Intake

```{r food-intake, dev=c('png','pdf')}
food.max <- 25
food.min <- 0
food.summary <- ddply(all.data.clean, ~Subject, summarize,
      Total=max(Feed.Acc..1))
food.summary.clean <- food.summary[food.summary$Total < food.max&food.summary$Total>0,]


food.summary.annotated <- merge(food.summary.clean, sample_key, by.x='Subject', by.y='Mouse.ID')
ymax <- max(food.summary.annotated$Total)
plot <- barplot(with(food.summary.annotated, tapply(Total, Particulate.Treatment, mean)), col=palette()[1:3],
                ylab="Cumulative Food Intake (g)",
                las=1, ylim=c(0,17))
superpose.eb(plot,
             with(food.summary.annotated, tapply(Total, Particulate.Treatment, mean)),
             with(food.summary.annotated, tapply(Total, Particulate.Treatment, se)))

food.aov <- aov(Total~Particulate.Treatment, data=food.summary.annotated)
food.kw <- kruskal.test(Total~Particulate.Treatment, data=food.summary.annotated)
food.levene <- leveneTest(Total~Particulate.Treatment, data=food.summary.annotated)
```

We next looked at cumulative food intake accross the groups, removing amy cages that looked to eat >`r food.max`g as these were likely associated with a mouse manually removing a pellet rather than eating it.  We looked at whether these data were normally distributed by a Shapiro-Wilk test and found that they were (p=`r shapiro.test(residuals(food.aov))$p.value`).  The variances were also equally distributed, via a Levene's test  (p=`r food.levene$"Pr(>F)"[1]`).  We therefore performed an ANOVA and found that these groups were not significantly different (p=`r summary(food.aov)[[1]]$"Pr(>F)"[1]`).

## Detailed Food Intake Analysis

```{r feeding-bouts}
feeding_folder <- '../data/CLAMS/Feeding bouts/'
feeding_data <- data.frame(matrix(ncol = 10, nrow = 0))
####
##Make a function that read the food intake from each animal to a dataframe
##Parameters: directory - the directory contains all the food intake files
##           start_ID - the smallest animal ID 
##           stop_ID - the biggest animal ID. We assume that animal_IDs are
##all consecutive numbers.
##           eliminate_ID - IDs of non-existing animals
##           out_data - the data that save the combined food intake
####
read.input <- function(directory, start_ID, stop_ID, eliminate_ID, out_data){
  for (i in start_ID:stop_ID){
    if (!(i %in% eliminate_ID)){
      feeding_file <- paste(directory, i, ".csv", sep="")
      data <- read.csv(feeding_file)
      names(data)[2] <- "Sample"
      names(data)[4] <- "Light_Dark"
      names(data)[7] <- "Duration"
      names(data)[8] <- "Weight"
      names(data)[9] <- "Accumulated"
      names(data)[10] <- "Animal_ID"
      data$Animal_ID <- i
      names(out_data) <- names(data)
      out_data <- rbind(out_data, data)
    }
  }
  return(out_data)
}

#load in all the feeding bouts
feeding_data.1 <-read.input(feeding_folder, 1096, 1122, NA, feeding_data)
feeding_data.2 <-read.input(feeding_folder, 1208, 1220, NA, feeding_data)
feeding_data <- rbind(feeding_data.1, feeding_data.2)
feeding_max <- 0.5
duration_max <- 300
library(lubridate)
feeding_data$Date.Time <- mdy_hms(feeding_data$Date.Time)

for (row in rownames(feeding_data)) {
  if (hour(feeding_data[row,]$Date.Time)>7&hour(feeding_data[row,]$Date.Time)<19){
    feeding_data[row,'Dark.Light'] <- 'Light'
  }
  else
    feeding_data[row,'Dark.Light'] <- 'Dark'
}
feeding_data$Dark.Light <- as.factor(feeding_data$Dark.Light)

feeding_bout_animal <-
  feeding_data %>%
  filter(Weight>0&Weight<feeding_max&Duration<duration_max) %>%
  group_by(Animal_ID) %>%
  dplyr::summarize(Median.Duration = median(Duration),
            Median.Weight = median(Weight),
            Bouts = length(Weight),
            Time = max(Date.Time)-min(Date.Time)) %>%
  mutate(Bouts.Time = Bouts/as.double(Time)) %>%
  inner_join(sample_key, by=c("Animal_ID" = "Mouse.ID"))

min_bouts <- 100
feeding_bout_summary <-
  subset(feeding_bout_animal, Bouts>min_bouts)%>%
  group_by(Particulate.Treatment) %>%
  dplyr::summarize(Duration = mean(Median.Duration),
                   Duration.se = se(Median.Duration),
                   Duration.shapiro = shapiro.test(Median.Duration)$p.value,
                   Weight = mean(Median.Weight)*1000,
                   Weight.se = se(Median.Weight)*1000,
                   Weight.shapiro = shapiro.test(Median.Weight)$p.value,
                   Feeding.Bouts = mean(Bouts.Time),
                   Feeding.Bouts.se = se(Bouts.Time),
                   Feeding.Bouts.shapiro = shapiro.test(Bouts.Time)$p.value)
par(mfrow=c(1,3))
ymax <- max(feeding_bout_summary$Duration + feeding_bout_summary$Duration.se)
plot <- with(feeding_bout_summary, barplot(Duration,
                                   names.arg=Particulate.Treatment,
                                   las=2, ylim=c(0,ymax),
                                   col=palette()[1:3],
                                   ylab="Median Feeding Duration (s)"))
superpose.eb(plot,feeding_bout_summary$Duration, feeding_bout_summary$Duration.se)

ymax <- max(feeding_bout_summary$Weight + feeding_bout_summary$Weight.se)
plot <- with(feeding_bout_summary, barplot(Weight,
                                   names.arg=Particulate.Treatment,
                                   las=2,ylim=c(0,ymax),
                                   col=palette()[1:3],
                                   ylab="Median Feeding Amount (mg)"))
superpose.eb(plot,feeding_bout_summary$Weight, feeding_bout_summary$Weight.se)

ymax <- max(feeding_bout_summary$Feeding.Bouts + feeding_bout_summary$Feeding.Bouts.se)
plot <- with(feeding_bout_summary, barplot(Feeding.Bouts,
                                   names.arg=Particulate.Treatment,
                                   las=2, ylim=c(0,ymax),
                                   col=palette()[1:3],
                                   ylab="Feeding Bouts per Day"))
superpose.eb(plot,feeding_bout_summary$Feeding.Bouts, feeding_bout_summary$Feeding.Bouts.se)
```

These data can be found in the folder `r feeding_folder`.  We calculated an median duration and median feeding amount, after excluding feeding bouts >`r feeding_max`g and feeding amounts >`r duration_max`s.  Greater than `r min_bouts` feeding bouts had to be detected per animal.  

### Feeding Amount
Normality can be assumed for all feeding amounts (p>`r min(feeding_bout_summary$Weight.shapiro)`) based on Shapiro-Wilk tests.  An ANOVA between the groups has a p-value of `r summary(aov(Median.Weight~Particulate.Treatment, data = feeding_bout_animal))[[1]]$"Pr(>F)"[1]`, so no significant differences are detected.  


### Feeding Duration
Normality can be assumed for feeding duration (p=`r min(feeding_bout_summary$Duration.shapiro)`).  An ANOVA shows significant difference between feeding durations (p=`r summary(aov(Median.Duration~Particulate.Treatment, data=feeding_bout_animal))[[1]]$"Pr(>F)"[1]`.  Equal variance can also be assumed (p=`r leveneTest(Median.Duration~Particulate.Treatment, data = feeding_bout_animal)$"Pr(>F)"[1]` via Levene's Test).  Pairwise Studen't *t*-tests are shown below:

```{r feeding-duration-t-tests}
library(knitr)
kable(with(feeding_bout_animal, 
           pairwise.wilcox.test(Median.Duration,Particulate.Treatment, p.adjust.method = "BH", var.equal=T))$p.value, 
      caption="Pairwise Wilcox Rank Sum tests, adjusted by the method of Benjamini and Hochberg")
```

## Feeding Bouts

Normality cannot be assumed for feeding duration (p=`r min(feeding_bout_summary$Feeding.Bouts.shapiro)`).  An Kruskal-Wallis test shows no significant difference between feeding durations (p=`r kruskal.test(Bouts~Particulate.Treatment, data=feeding_bout_animal)$p.value`).  

## Separating Feeding Behavior by Day and Night

```{r feeding-day-night, dev=c('png','pdf')}
feeding_bout_animal_dn <-
  feeding_data %>%
  filter(Weight>0&Weight<feeding_max&Duration<duration_max) %>%
  group_by(Animal_ID, Dark.Light) %>%
  dplyr::summarize(Median.Duration = median(Duration),
            Median.Weight = median(Weight),
            Bouts = length(Weight),
            Time = max(Date.Time)-min(Date.Time)) %>%
  mutate(Bouts.Time = Bouts/as.double(Time)) %>%
  inner_join(sample_key, by=c("Animal_ID" = "Mouse.ID"))

feeding_bout_summary_dn <-
  subset(feeding_bout_animal_dn, Bouts>min_bouts)%>%
  group_by(Particulate.Treatment, Dark.Light) %>%
  dplyr::summarize(Duration = mean(Median.Duration),
                   Duration.se = se(Median.Duration),
                   Weight = mean(Median.Weight)*1000,
                   Weight.se = se(Median.Weight)*1000,
                   Feeding.Bouts = mean(Bouts.Time),
                   Feeding.Bouts.se = se(Bouts.Time))

par(mfrow=c(2,3))
ymax <- max(feeding_bout_summary_dn$Duration + feeding_bout_summary_dn$Duration.se)
plot <- with(subset(feeding_bout_summary_dn, Dark.Light=="Dark"), barplot(Duration,
                                   names.arg=Particulate.Treatment,
                                   las=2, ylim=c(0,ymax),
                                   col=palette()[1:3],
                                   main="Dark Duration",
                                   ylab="Median Feeding Duration (s)"))
with(subset(feeding_bout_summary_dn, Dark.Light=="Dark"),
     superpose.eb(plot,Duration, Duration.se))

ymax <- max(feeding_bout_summary_dn$Weight + feeding_bout_summary_dn$Weight.se)
plot <- with(subset(feeding_bout_summary_dn, Dark.Light=="Dark"), barplot(Weight,
                                   names.arg=Particulate.Treatment,
                                   las=2,ylim=c(0,ymax),
                                   col=palette()[1:3],
                                   main="Dark Food per Meal",
                                   ylab="Median Feeding Amount (mg)"))
with(subset(feeding_bout_summary_dn, Dark.Light=="Dark"),
     superpose.eb(plot,Weight, Weight.se))

ymax <- max(feeding_bout_summary_dn$Feeding.Bouts + feeding_bout_summary_dn$Feeding.Bouts.se)
plot <- with(subset(feeding_bout_summary_dn, Dark.Light=="Dark"), barplot(Feeding.Bouts,
                                   names.arg=Particulate.Treatment,
                                   las=2, ylim=c(0,ymax),
                                   col=palette()[1:3],
                                   main="Dark Meals",
                                   ylab="Feeding Bouts per Day"))
with(subset(feeding_bout_summary_dn, Dark.Light=="Dark"),
     superpose.eb(plot,Feeding.Bouts, Feeding.Bouts.se))

ymax <- max(feeding_bout_summary_dn$Duration + feeding_bout_summary_dn$Duration.se)
plot <- with(subset(feeding_bout_summary_dn, Dark.Light=="Light"), barplot(Duration,
                                   names.arg=Particulate.Treatment,
                                   las=2, ylim=c(0,ymax),
                                   col=palette()[1:3],
                                   main="Light Duration",
                                   ylab="Median Feeding Duration (s)"))
with(subset(feeding_bout_summary_dn, Dark.Light=="Light"),
     superpose.eb(plot,Duration, Duration.se))

ymax <- max(feeding_bout_summary_dn$Weight + feeding_bout_summary_dn$Weight.se)
plot <- with(subset(feeding_bout_summary_dn, Dark.Light=="Light"), barplot(Weight,
                                   names.arg=Particulate.Treatment,
                                   las=2,ylim=c(0,ymax),
                                   col=palette()[1:3],
                                   main="Light Food per Meal",
                                   ylab="Median Feeding Amount (mg)"))
with(subset(feeding_bout_summary_dn, Dark.Light=="Light"),
     superpose.eb(plot,Weight, Weight.se))

ymax <- max(feeding_bout_summary_dn$Feeding.Bouts + feeding_bout_summary_dn$Feeding.Bouts.se)
plot <- with(subset(feeding_bout_summary_dn, Dark.Light=="Light"), barplot(Feeding.Bouts,
                                   names.arg=Particulate.Treatment,
                                   las=2, ylim=c(0,ymax),
                                   col=palette()[1:3],
                                   main="Light Meals",
                                   ylab="Feeding Bouts per Day"))
with(subset(feeding_bout_summary_dn, Dark.Light=="Light"),
     superpose.eb(plot,Feeding.Bouts, Feeding.Bouts.se))

```

### Individualized Feeding Behavior

```{r feeding-individual, dev=c('png','pdf')}
feeding_bout_animal$Animal_ID <- factor(feeding_bout_animal$Animal_ID)
combined_feeding <- inner_join(feeding_bout_animal, mri_data, by=c("Animal_ID"="Label"))
combined_feeding <- inner_join(combined_feeding, food.summary.clean, by=c("Animal_ID"="Subject"))
combined_feeding$Food.Day <- combined_feeding$Total/as.double(combined_feeding$Time)

#total food intake

with(combined_feeding, plot(Lean,Food.Day, pch=19, las=2,
                            col=Particulate.Treatment,
                            xlab="Fat Free Mass (g)",
                            ylim=c(0,max(Food.Day)),
                            ylab="Daily Food Intake (g)"))
combined_feeding$Particulate.Treatment <- relevel(combined_feeding$Particulate.Treatment, ref="MCP")

par(mfrow=c(1,3))
with(combined_feeding, plot(Lean,Median.Duration, pch=19, las=2,
                            col=Particulate.Treatment,
                            xlab="Fat Free Mass (g)",
                            ylim=c(0,max(Median.Duration)),
                            ylab="Median Feeding Duration (s)"))

with(combined_feeding, plot(Lean,Median.Weight*1000, pch=19, las=2,
                            col=Particulate.Treatment,
                            xlab="Fat Free Mass (g)",
                            ylim=c(0,max(Median.Weight)*1000),
                            ylab="Median Feeding Amount (mg)"))

with(combined_feeding, plot(Lean,Bouts.Time, pch=19, las=2,
                            col=Particulate.Treatment,
                            xlab="Fat Free Mass (g)",
                            ylim=c(0,max(Bouts.Time)),
                            ylab="Feeding Bouts per Day"))


```

## Session Information
```{r sessionInfo}
sessionInfo()
```